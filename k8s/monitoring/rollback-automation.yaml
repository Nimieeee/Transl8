apiVersion: v1
kind: ConfigMap
metadata:
  name: rollback-automation-config
  namespace: monitoring
data:
  rollback-rules.yml: |
    # Automated Rollback Rules
    # These rules trigger automatic rollback when critical thresholds are exceeded
    
    rules:
      # Critical error rate triggers immediate rollback
      - name: critical_error_rate
        condition: |
          (
            sum(rate(http_requests_total{status=~"5..",namespace="production"}[5m])) by (deployment)
            /
            sum(rate(http_requests_total{namespace="production"}[5m])) by (deployment)
          ) > 0.10
        duration: 5m
        action: rollback
        severity: critical
        message: "Error rate exceeded 10% for 5 minutes"
      
      # Severe response time degradation
      - name: severe_latency
        condition: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket{namespace="production"}[5m])) by (le, deployment)
          ) > 5
        duration: 5m
        action: rollback
        severity: critical
        message: "P95 response time exceeded 5 seconds"
      
      # Pod crash loop
      - name: pod_crash_loop
        condition: |
          rate(kube_pod_container_status_restarts_total{namespace="production"}[10m]) > 0.5
        duration: 5m
        action: rollback
        severity: critical
        message: "Pods are crash looping"
      
      # Database connection failures
      - name: database_connection_failure
        condition: |
          sum(rate(database_connection_errors_total{namespace="production"}[5m])) by (deployment) > 10
        duration: 3m
        action: rollback
        severity: critical
        message: "Database connection errors detected"
      
      # Memory exhaustion
      - name: memory_exhaustion
        condition: |
          (
            container_memory_usage_bytes{namespace="production",container!=""}
            /
            container_spec_memory_limit_bytes
          ) > 0.95
        duration: 5m
        action: alert
        severity: warning
        message: "Container memory usage exceeded 95%"
      
      # Queue backup
      - name: queue_backup
        condition: |
          redis_queue_length{namespace="production"} > 10000
        duration: 10m
        action: alert
        severity: warning
        message: "Job queue depth exceeded 10,000"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rollback-script
  namespace: monitoring
data:
  rollback.sh: |
    #!/bin/bash
    # Automated Rollback Script
    # Triggered by monitoring alerts when critical thresholds are exceeded
    
    set -e
    
    NAMESPACE=${1:-production}
    DEPLOYMENT=$2
    REASON=${3:-"Automated rollback triggered"}
    
    echo "=========================================="
    echo "AUTOMATED ROLLBACK INITIATED"
    echo "Namespace: $NAMESPACE"
    echo "Deployment: $DEPLOYMENT"
    echo "Reason: $REASON"
    echo "=========================================="
    
    # Determine if this is a blue-green deployment
    if [[ $DEPLOYMENT == *"-green" ]]; then
        BLUE_DEPLOYMENT="${DEPLOYMENT%-green}-blue"
        
        echo "Blue-green deployment detected"
        echo "Switching traffic from green to blue..."
        
        # Switch service selector back to blue
        SERVICE_NAME="${DEPLOYMENT%-green}-service"
        kubectl patch service $SERVICE_NAME -n $NAMESPACE \
          -p '{"spec":{"selector":{"version":"blue"}}}'
        
        echo "Traffic switched to blue deployment"
        
        # Scale down green deployment
        echo "Scaling down green deployment..."
        kubectl scale deployment/$DEPLOYMENT --replicas=0 -n $NAMESPACE
        
    else
        echo "Standard deployment detected"
        echo "Rolling back to previous revision..."
        
        # Rollback to previous revision
        kubectl rollout undo deployment/$DEPLOYMENT -n $NAMESPACE
        
        # Wait for rollback to complete
        kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE --timeout=5m
    fi
    
    echo "=========================================="
    echo "ROLLBACK COMPLETED"
    echo "=========================================="
    
    # Send notification
    curl -X POST "${SLACK_WEBHOOK_URL}" \
      -H 'Content-Type: application/json' \
      -d "{
        \"text\": \"ðŸš¨ Automated rollback completed\",
        \"attachments\": [{
          \"color\": \"danger\",
          \"fields\": [
            {\"title\": \"Namespace\", \"value\": \"$NAMESPACE\", \"short\": true},
            {\"title\": \"Deployment\", \"value\": \"$DEPLOYMENT\", \"short\": true},
            {\"title\": \"Reason\", \"value\": \"$REASON\", \"short\": false}
          ]
        }]
      }"
    
    # Create incident in PagerDuty
    curl -X POST "https://api.pagerduty.com/incidents" \
      -H "Authorization: Token token=${PAGERDUTY_API_KEY}" \
      -H "Content-Type: application/json" \
      -d "{
        \"incident\": {
          \"type\": \"incident\",
          \"title\": \"Automated rollback: $DEPLOYMENT\",
          \"service\": {
            \"id\": \"${PAGERDUTY_SERVICE_ID}\",
            \"type\": \"service_reference\"
          },
          \"urgency\": \"high\",
          \"body\": {
            \"type\": \"incident_body\",
            \"details\": \"$REASON\"
          }
        }
      }"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: rollback-job-template
  namespace: monitoring
spec:
  template:
    spec:
      serviceAccountName: rollback-automation
      containers:
      - name: rollback
        image: bitnami/kubectl:latest
        command: ["/bin/bash"]
        args: ["/scripts/rollback.sh", "$(NAMESPACE)", "$(DEPLOYMENT)", "$(REASON)"]
        env:
        - name: NAMESPACE
          value: "production"
        - name: DEPLOYMENT
          value: "backend-green"
        - name: REASON
          value: "Automated rollback triggered by monitoring"
        - name: SLACK_WEBHOOK_URL
          valueFrom:
            secretKeyRef:
              name: notification-secrets
              key: slack-webhook-url
        - name: PAGERDUTY_API_KEY
          valueFrom:
            secretKeyRef:
              name: notification-secrets
              key: pagerduty-api-key
        - name: PAGERDUTY_SERVICE_ID
          valueFrom:
            secretKeyRef:
              name: notification-secrets
              key: pagerduty-service-id
        volumeMounts:
        - name: rollback-script
          mountPath: /scripts
      volumes:
      - name: rollback-script
        configMap:
          name: rollback-script
          defaultMode: 0755
      restartPolicy: Never
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rollback-automation
  namespace: monitoring
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: rollback-automation
rules:
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "patch", "update"]
- apiGroups: ["apps"]
  resources: ["deployments/rollback"]
  verbs: ["create"]
- apiGroups: [""]
  resources: ["services"]
  verbs: ["get", "patch", "update"]
- apiGroups: ["apps"]
  resources: ["deployments/scale"]
  verbs: ["get", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: rollback-automation
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: rollback-automation
subjects:
- kind: ServiceAccount
  name: rollback-automation
  namespace: monitoring
