// Prisma schema for AI Video Dubbing Platform - Transl8

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum SubscriptionTier {
  FREE
  CREATOR
  PRO
  ENTERPRISE
}

enum ProjectStatus {
  DRAFT
  UPLOADING
  PROCESSING
  COMPLETED
  FAILED
  ARCHIVED
}

enum JobStage {
  STT
  MT
  TTS
  MUXING
  LIPSYNC
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// User accounts and authentication
model User {
  id                      String            @id @default(cuid())
  email                   String            @unique
  password                String            // bcrypt hashed (renamed from passwordHash for compatibility)
  passwordHash            String?           // For backward compatibility
  
  // Beta testing
  isBetaTester            Boolean           @default(false) @map("is_beta_tester")
  betaInviteCode          String?           @unique @map("beta_invite_code")
  betaOnboardedAt         DateTime?         @map("beta_onboarded_at")
  
  // Subscription
  subscriptionTier        SubscriptionTier  @default(FREE) @map("subscription_tier")
  subscriptionStatus      String?           @map("subscription_status")
  stripeCustomerId        String?           @unique @map("stripe_customer_id")
  stripeSubscriptionId    String?           @unique @map("stripe_subscription_id")
  cancelAtPeriodEnd       Boolean           @default(false) @map("cancel_at_period_end")
  
  // Usage tracking
  processingMinutesUsed   Int               @default(0) @map("processing_minutes_used")
  processingMinutesLimit  Int               @default(10) @map("processing_minutes_limit")
  
  createdAt               DateTime          @default(now()) @map("created_at")
  updatedAt               DateTime          @updatedAt @map("updated_at")
  
  // Relations
  projects                Project[]
  voiceClones             VoiceClone[]
  glossaries              Glossary[]
  jobs                    DubbingJob[]      // For backward compatibility
  feedback                Feedback[]

  @@map("users")
}

// Projects
model Project {
  id                String          @id @default(cuid())
  userId            String          @map("user_id")
  name              String
  status            ProjectStatus   @default(DRAFT)
  
  sourceLanguage    String          @map("source_language")
  targetLanguage    String          @map("target_language")
  
  videoUrl          String?         @map("video_url")
  audioUrl          String?         @map("audio_url")
  outputVideoUrl    String?         @map("output_video_url")
  thumbnailUrl      String?         @map("thumbnail_url")
  
  duration          Float?          // in seconds
  voiceConfig       Json?           @map("voice_config")
  
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  
  // Relations
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  transcripts       Transcript[]
  translations      Translation[]
  jobs              Job[]

  @@index([userId])
  @@index([status])
  @@map("projects")
}

// Transcripts
model Transcript {
  id              String    @id @default(cuid())
  projectId       String    @map("project_id")
  content         Json      // TranscriptContent
  editedContent   Json?     @map("edited_content")
  confidence      Float?
  speakerCount    Int?      @map("speaker_count")
  approved        Boolean   @default(false)
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Relations
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("transcripts")
}

// Translations
model Translation {
  id              String    @id @default(cuid())
  projectId       String    @map("project_id")
  targetLanguage  String    @map("target_language")
  content         Json      // TranslationContent
  editedContent   Json?     @map("edited_content")
  glossaryApplied Boolean   @default(false) @map("glossary_applied")
  approved        Boolean   @default(false)
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Relations
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("translations")
}

// Voice Clones
model VoiceClone {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  name            String
  sampleAudioUrl  String    @map("sample_audio_url")
  modelData       Json      @map("model_data")
  language        String?
  quality         Float?
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("voice_clones")
}

// Jobs (Pipeline stages)
model Job {
  id              String      @id @default(cuid())
  projectId       String      @map("project_id")
  stage           JobStage
  status          JobStatus   @default(PENDING)
  progress        Int         @default(0)
  errorMessage    String?     @map("error_message")
  metadata        Json?
  retryCount      Int         @default(0) @map("retry_count")
  
  startedAt       DateTime?   @map("started_at")
  completedAt     DateTime?   @map("completed_at")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  
  // Relations
  project         Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([stage])
  @@index([status])
  @@map("jobs")
}

// Glossary
model Glossary {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  sourceLanguage  String    @map("source_language")
  targetLanguage  String    @map("target_language")
  sourceTerm      String    @map("source_term")
  targetTerm      String    @map("target_term")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sourceLanguage, targetLanguage])
  @@map("glossaries")
}

// Dubbing jobs (for backward compatibility with MVP)
model DubbingJob {
  id              String    @id @default(cuid())
  userId          String?   @map("user_id")
  
  status          String
  progress        Int       @default(0)
  
  originalFile    String    @map("original_file")
  outputFile      String?   @map("output_file")
  
  sourceLanguage  String    @default("en") @map("source_language")
  targetLanguage  String    @default("es") @map("target_language")
  
  error           String?
  
  createdAt       DateTime  @default(now()) @map("created_at")
  completedAt     DateTime? @map("completed_at")
  expiresAt       DateTime? @map("expires_at")
  
  // Relations
  user            User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  contextMap      ContextMap?

  @@index([userId])
  @@index([status])
  @@map("dubbing_jobs")
}

// Context Map for robust pipeline
model ContextMap {
  id                  String    @id @default(cuid())
  projectId           String    @unique @map("project_id")
  originalDurationMs  Int       @map("original_duration_ms")
  sourceLanguage      String    @map("source_language")
  targetLanguage      String    @map("target_language")
  
  // JSON content with all segments
  content             Json
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  
  // Relations
  project             DubbingJob @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("context_maps")
}

// Adaptation Quality Metrics
model AdaptationMetrics {
  id                        String    @id @default(cuid())
  projectId                 String    @unique @map("project_id")
  languagePair              String    @map("language_pair")
  
  totalSegments             Int       @map("total_segments")
  successfulSegments        Int       @map("successful_segments")
  failedSegments            Int       @map("failed_segments")
  successRate               Float     @map("success_rate")
  averageAttempts           Float     @map("average_attempts")
  
  // JSON object with validation failure reasons and counts
  validationFailureReasons  Json      @map("validation_failure_reasons")
  
  createdAt                 DateTime  @default(now()) @map("created_at")

  @@index([languagePair])
  @@index([createdAt])
  @@map("adaptation_metrics")
}

// Audio Quality Metrics
model AudioQualityMetrics {
  id                    String    @id @default(cuid())
  projectId             String    @map("project_id")
  segmentId             Int       @map("segment_id")
  
  // Vocal isolation metrics
  vocalIsolationSnr     Float?    @map("vocal_isolation_snr")
  spectralPurity        Float?    @map("spectral_purity")
  
  // Noise reduction metrics
  noiseReductionSnr     Float?    @map("noise_reduction_snr")
  noiseReductionDb      Float?    @map("noise_reduction_db")
  
  // TTS output quality
  ttsQualityScore       Float?    @map("tts_quality_score")
  ttsConfidence         Float?    @map("tts_confidence")
  
  createdAt             DateTime  @default(now()) @map("created_at")

  @@index([projectId])
  @@index([createdAt])
  @@map("audio_quality_metrics")
}

// Synchronization Quality Metrics
model SyncQualityMetrics {
  id                    String    @id @default(cuid())
  projectId             String    @unique @map("project_id")
  
  // Timing accuracy
  totalSegments         Int       @map("total_segments")
  maxDriftMs            Float     @map("max_drift_ms")
  averageDriftMs        Float     @map("average_drift_ms")
  
  // Segment-level accuracy
  segmentAccuracy       Json      @map("segment_accuracy") // Array of per-segment drift
  
  // Overall quality score
  syncQualityScore      Float     @map("sync_quality_score")
  
  createdAt             DateTime  @default(now()) @map("created_at")

  @@index([projectId])
  @@index([createdAt])
  @@map("sync_quality_metrics")
}

// Support Tickets
model SupportTicket {
  id              String                  @id @default(cuid())
  userId          String                  @map("user_id")
  subject         String
  description     String
  status          String                  @default("open") // open, in_progress, resolved, closed
  priority        String                  @default("medium") // low, medium, high, urgent
  category        String?
  
  createdAt       DateTime                @default(now()) @map("created_at")
  updatedAt       DateTime                @updatedAt @map("updated_at")
  resolvedAt      DateTime?               @map("resolved_at")
  
  // Relations
  messages        SupportTicketMessage[]

  @@index([userId])
  @@index([status])
  @@map("support_tickets")
}

model SupportTicketMessage {
  id              String          @id @default(cuid())
  ticketId        String          @map("ticket_id")
  userId          String?         @map("user_id") // null for admin messages
  message         String
  isStaff         Boolean         @default(false) @map("is_staff")
  
  createdAt       DateTime        @default(now()) @map("created_at")
  
  // Relations
  ticket          SupportTicket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@map("support_ticket_messages")
}

// Abuse Reports
model AbuseReport {
  id              String    @id @default(cuid())
  reporterId      String?   @map("reporter_id") // null for anonymous
  contentType     String    @map("content_type") // project, voice_clone, etc
  contentId       String    @map("content_id")
  reason          String
  description     String?
  status          String    @default("pending") // pending, reviewing, resolved, dismissed
  reviewedAt      DateTime? @map("reviewed_at")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  resolvedAt      DateTime? @map("resolved_at")

  @@index([contentType, contentId])
  @@index([status])
  @@map("abuse_reports")
}

// Feedback
model Feedback {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  type            String    // bug, feature, improvement, other
  category        String?
  title           String
  description     String
  rating          Int?      // 1-5
  status          String    @default("open") // open, reviewing, planned, completed, closed
  priority        String    @default("medium") // low, medium, high
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@map("feedback")
}
